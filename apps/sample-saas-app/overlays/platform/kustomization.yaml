apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
namespace: platform
resources:
  - ../../base
  - namespace.yaml
  - aws-secrets-manager.yaml
  - secret-sync-job.yaml
commonLabels:
  tenant: platform
  environment: dev
  app.kubernetes.io/managed-by: flux

# Image configuration - AUTO-UPDATED by CD pipeline
# These values are dynamically updated by the CD pipeline from GitHub secrets
# Do not hardcode ECR repository names - they are constructed from:
# - AWS account ID (from AWS API)
# - AWS region (from workflow env)
# - ECR repository names (from GitHub secrets: ECR_BACKEND_REPO, ECR_FRONTEND_REPO)
images:
  - name: task-management-backend
    # Auto-updated by CD pipeline - placeholder format for initial deployment
    newName: 000000000000.dkr.ecr.us-east-1.amazonaws.com/placeholder-backend-repo
    newTag: latest  # Auto-updated by CD pipeline
  - name: task-management-frontend
    # Auto-updated by CD pipeline - placeholder format for initial deployment
    newName: 000000000000.dkr.ecr.us-east-1.amazonaws.com/placeholder-frontend-repo
    newTag: latest  # Auto-updated by CD pipeline

patches:
  - patch: |-
      - op: add
        path: /spec/template/metadata/labels/tenant
        value: platform
    target:
      kind: Deployment
      name: backend
  - patch: |-
      - op: add
        path: /spec/template/metadata/labels/tenant
        value: platform
    target:
      kind: Deployment
      name: frontend
  - patch: |-
      - op: add
        path: /metadata/labels/tenant
        value: platform
    target:
      kind: Service
      name: backend-service
  - patch: |-
      - op: add
        path: /metadata/labels/tenant
        value: platform
    target:
      kind: Service
      name: frontend-service
  - patch: |-
      - op: replace
        path: /spec/selector/tenant
        value: platform
    target:
      kind: Service
      name: backend-service
  - patch: |-
      - op: replace
        path: /spec/selector/tenant
        value: platform
    target:
      kind: Service
      name: frontend-service
